name: Build GizmoSQLLine

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Build, test, and verify
      run: mvn -B clean verify --file pom.xml

    - name: Package executable
      run: mvn -B package -DskipTests --file pom.xml

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gizmosqlline
        path: |
          target/gizmosqlline
          target/gizmosqlline.jar
          target/gizmosqlline.bat
        retention-days: 30

  release:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Build, test, and package
      run: mvn -B clean verify package --file pom.xml

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: GizmoSQLLine v${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        files: |
          target/gizmosqlline
          target/gizmosqlline.jar
          target/gizmosqlline.bat
        body: |
          ## GizmoSQLLine v${{ steps.get_version.outputs.VERSION }}

          A Flight SQL-specific version of SQLLine for connecting to GizmoSQL instances.

          ### Downloads

          | Platform | File | Instructions |
          |----------|------|--------------|
          | Linux/macOS | `gizmosqlline` | `chmod +x gizmosqlline && ./gizmosqlline` |
          | Windows | `gizmosqlline.jar` + `gizmosqlline.bat` | Download both to same folder, run `gizmosqlline.bat` |
          | Any (manual) | `gizmosqlline.jar` | `java -jar gizmosqlline.jar` |

          ### Quick Install (Linux/macOS)

          ```bash
          curl -L -o gizmosqlline https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.VERSION }}/gizmosqlline
          chmod +x gizmosqlline
          sudo mv gizmosqlline /usr/local/bin/
          ```

          ### Usage

          ```bash
          # Interactive mode
          ./gizmosqlline

          # Direct connection
          ./gizmosqlline -u "jdbc:arrow-flight-sql://localhost:31337" -n user -p password
          ```

          **Requires:** Java 11+ runtime installed
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
