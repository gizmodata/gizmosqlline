name: Build GizmoSQLLine

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Build and unit test
      run: mvn -B clean package --file pom.xml

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gizmosqlline
        path: |
          target/gizmosqlline
          target/gizmosqlline.jar
          target/gizmosqlline.bat
        retention-days: 30

  integration-test:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        jdk: ['11', '17', '21', '25']

    services:
      gizmosql:
        image: gizmodata/gizmosql:latest
        ports:
          - 31337:31337
        env:
          GIZMOSQL_USERNAME: gizmosql_username
          GIZMOSQL_PASSWORD: gizmosql_password
          TLS_ENABLED: "1"
          PRINT_QUERIES: "1"

    steps:
    - name: Wait for GizmoSQL
      run: |
        for i in $(seq 1 30); do
          nc -z localhost 31337 && echo "GizmoSQL is ready" && exit 0
          echo "Waiting for GizmoSQL... ($i/30)"
          sleep 2
        done
        echo "GizmoSQL did not start in time" && exit 1

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gizmosqlline

    - name: Set up JDK ${{ matrix.jdk }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.jdk }}
        distribution: 'temurin'

    - name: Test JDBC connection (JDK ${{ matrix.jdk }})
      run: |
        echo "Java version:"
        java -version

        # --enable-native-access requires Java 16+
        JAVA_MAJOR=$(java -version 2>&1 | head -1 | sed 's/.*"\([0-9]*\).*/\1/')
        NA=""
        if [ "$JAVA_MAJOR" -ge 16 ] 2>/dev/null; then
          NA="--enable-native-access=ALL-UNNAMED"
        fi

        # First, run a diagnostic test to catch detailed errors
        cat > /tmp/TestConnection.java << 'TESTEOF'
        import java.sql.*;
        public class TestConnection {
            public static void main(String[] args) {
                System.out.println("Java: " + System.getProperty("java.version"));
                try {
                    Class.forName("org.apache.arrow.driver.jdbc.ArrowFlightJdbcDriver");
                    System.out.println("Driver loaded OK");
                } catch (Throwable e) {
                    System.err.println("Driver load failed:");
                    e.printStackTrace();
                    System.exit(1);
                }
                try (Connection conn = DriverManager.getConnection(
                        "jdbc:gizmosql://localhost:31337?useEncryption=true&disableCertificateVerification=true",
                        "gizmosql_username", "gizmosql_password");
                     Statement stmt = conn.createStatement();
                     ResultSet rs = stmt.executeQuery("SELECT 1 AS v")) {
                    rs.next();
                    System.out.println("Query result: " + rs.getInt(1));
                    System.out.println("SUCCESS: JDBC connection works on JDK " + System.getProperty("java.version"));
                } catch (Throwable e) {
                    System.err.println("Connection failed - full exception chain:");
                    Throwable t = e;
                    while (t != null) {
                        System.err.println(">>> " + t.getClass().getName() + ": " + t.getMessage());
                        t = t.getCause();
                    }
                    System.err.println("\nFull stack trace:");
                    e.printStackTrace();
                    System.exit(1);
                }
            }
        }
        TESTEOF

        javac -cp gizmosqlline.jar /tmp/TestConnection.java -d /tmp
        java --add-opens=java.base/java.nio=ALL-UNNAMED \
             $NA \
             -cp /tmp:gizmosqlline.jar \
             TestConnection

  release:
    needs: [build, integration-test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Build, test, and package
      run: mvn -B clean verify package --file pom.xml

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: GizmoSQLLine v${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        files: |
          target/gizmosqlline
          target/gizmosqlline.jar
          target/gizmosqlline.bat
        body: |
          ## GizmoSQLLine v${{ steps.get_version.outputs.VERSION }}

          A GizmoSQL JDBC-based version of SQLLine for connecting to GizmoSQL instances.

          ### Install via Homebrew (Recommended)

          ```bash
          brew install gizmodata/tap/gizmosqlline
          ```

          ### Downloads

          | Platform | File | Instructions |
          |----------|------|--------------|
          | Linux/macOS | `gizmosqlline` | `chmod +x gizmosqlline && ./gizmosqlline` |
          | Windows | `gizmosqlline.jar` + `gizmosqlline.bat` | Download both to same folder, run `gizmosqlline.bat` |
          | Any (manual) | `gizmosqlline.jar` | `java --add-opens=java.base/java.nio=ALL-UNNAMED --enable-native-access=ALL-UNNAMED -jar gizmosqlline.jar` |

          ### Quick Install (Linux/macOS)

          ```bash
          curl -L -o gizmosqlline https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.VERSION }}/gizmosqlline
          chmod +x gizmosqlline
          sudo mv gizmosqlline /usr/local/bin/
          ```

          ### Usage

          ```bash
          # Interactive mode
          gizmosqlline

          # Direct connection
          gizmosqlline -u "jdbc:gizmosql://localhost:31337" -n user -p password
          ```

          **Requires:** Java 11+ runtime (Homebrew install handles this automatically)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update Homebrew formula
      env:
        GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
      run: |
        # Get version and SHA256
        VERSION=${{ steps.get_version.outputs.VERSION }}
        SHA256=$(sha256sum target/gizmosqlline.jar | cut -d' ' -f1)

        # Clone the tap repo
        git clone https://x-access-token:${GH_TOKEN}@github.com/gizmodata/homebrew-tap.git tap
        cd tap

        # Update the formula
        cat > Formula/gizmosqlline.rb << 'FORMULA'
        class Gizmosqlline < Formula
          desc "GizmoSQL JDBC command-line client for GizmoSQL servers"
          homepage "https://github.com/gizmodata/gizmosqlline"
          version "VERSION_PLACEHOLDER"
          license "Apache-2.0"

          url "https://github.com/gizmodata/gizmosqlline/releases/download/v#{version}/gizmosqlline.jar"
          sha256 "SHA256_PLACEHOLDER"

          depends_on "openjdk"

          def install
            libexec.install "gizmosqlline.jar"

            (bin/"gizmosqlline").write <<~EOS
              #!/bin/bash
              export JAVA_HOME="#{Formula["openjdk"].opt_prefix}"
              exec "${JAVA_HOME}/bin/java" --add-opens=java.base/java.nio=ALL-UNNAMED --enable-native-access=ALL-UNNAMED -jar "#{libexec}/gizmosqlline.jar" "$@"
            EOS
          end

          def caveats
            <<~EOS
              GizmoSQLLine is a GizmoSQL JDBC command-line client.

              To start in interactive mode:
                gizmosqlline

              To connect directly:
                gizmosqlline -u "jdbc:gizmosql://localhost:31337" -n user -p password

              For help with SQLLine commands, type !help after connecting.
            EOS
          end

          test do
            output = shell_output("#{bin}/gizmosqlline --help 2>&1", 0)
            assert_match "GizmoSQLLine", output
          end
        end
        FORMULA

        # Replace placeholders
        sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" Formula/gizmosqlline.rb
        sed -i "s/SHA256_PLACEHOLDER/${SHA256}/g" Formula/gizmosqlline.rb

        # Commit and push
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Formula/gizmosqlline.rb
        git commit -m "Update gizmosqlline to ${VERSION}"
        git push
